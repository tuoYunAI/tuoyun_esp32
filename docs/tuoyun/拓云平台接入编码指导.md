# ESP32-XIAOZHI业务修改设计

#  业务功能变动说明

## 1.1 设备信息配置

通过配置补充设备板卡信息和固件信息，实现设备开机自动注册登记信息。

```c


config MANUFACTURER_PRODUCT_TYPE
    string "PRODUCT TYPE"
    default "{please contact tuoyun}"
    help
        产品的型号

config MANUFACTURER_BOARD_TYPE
    string "BOARD TYPE"
    default "{please contact tuoyun}"
    help
        主控板的型号

config MANUFACTURER_APPLICATION_TYPE
    string "APPLICATION TYPE"
    default "{please contact tuoyun}"
    help
        固件编号

config MANUFACTURER_CODE
    string "Manufacturer Code"
    default "5143932590709531730"
    help
       设备厂商编码(UID)



```

## 1.2 OTA

本系统需要支持不同厂商的设备通过OTA自动注册和固件版本信息。OTA修改如下。

### 1.2.1 Kconfig.projbuild (OTA地址)

OTA的URL修改如下。

```c
config OTA_URL
    string "Default OTA URL"
    default "https://ota.lovaiot.com/ota/"          // 修改OTA地址
    help
        The application will access this URL to check for new firmwares and server address.

```

### 1.2.2 ota.h (修改)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/125cb27c-9fe7-4693-8609-a37c9b1fcd71.png)

### 1.2.3 ota.cc (修改)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/30c8dd4a-ef88-416f-8a6e-128837eab2af.png)

### 1.2.2 board.cc (OTA的请求信息补充信息)

在OTA请求的消息体中增加两个type字段，如下

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/6f358db9-9ee2-4ae1-9013-eccc831dd5ce.png)

### 1.2.3 wifi\_board.cc (订阅设备的MQTT主题)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/e22bc81c-f66b-4760-85fe-a62adaef1573.png)

### 1.2.3 protocol.cc (订阅设备的MQTT主题)

OTA响应消息中会携带本机需要订阅的mqtt主题，需要补充解析和进行订阅操作，如下

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/d7068024-c2cd-499b-a608-095d6938796a.png)

## 1.3 绑定激活提示

设备启用时需要绑定设备，绑定成功时，在设备上发出声音提示。

```c++
void Application::CheckNewVersion(Ota& ota) {
        // ...

        

        // This will block the loop until the activation is done or timeout
        for (int i = 0; i < 10; ++i) {
            ESP_LOGI(TAG, "Activating... %d/%d", i + 1, 10);
            esp_err_t err = ota.Activate();
            if (err == ESP_OK) {
                xEventGroupSetBits(event_group_, MAIN_EVENT_CHECK_NEW_VERSION_DONE);
                PlaySound(Lang::Sounds::OGG_WELCOME);                                        // 增加提示
                break;
            } else if (err == ESP_ERR_TIMEOUT) {
                vTaskDelay(pdMS_TO_TICKS(1000));                                             // 缩短检测周期 3000 -> 1000
            } else {
                vTaskDelay(pdMS_TO_TICKS(10000));
            }
            if (device_state_ == kDeviceStateIdle) {
                break;
            }
        }
    }
}
```

## 1.4 服务授权过期提醒

当设备的AI接入license过期后，用户使用AI服务时，系统会提示服务已经过期。

### 1.4.1 mqtt\_protocol.h （修改）

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/cbbc6aa8-4f92-4949-98ac-2c605164e118.png)

### 1.4.2 mqtt\_protocol.cc （修改）

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/685c432f-d24d-4f9a-bd25-0e438d2b2caa.png)

### 1.4.3 增加提示文本

需要在多语言文件中增加描述字符串文本，例如：

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/fe519353-f648-467a-9c16-90d152e93ff3.png)

## 1.5 蓝牙配网

设备在未配置网络、WIFI联网失败、没有绑定用户时，会进入配网模式。

### 1.5.1 board.h （修改）

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/3b8ad8d7-c6a2-4f0c-9a0c-df74446d50d1.png)

### 1.5.2 board.cc （修改）

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/d47aaaca-f673-4d1d-b682-30933353450c.png)

### 1.5.3 wifi\_board.h （修改）

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/14f22761-2733-4497-893b-c0f0e417b25a.png)

### 1.5.4 wifi\_board.cc （修改）

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/96797d23-0b8a-43d4-8b1b-5ad8ee3e26c6.png)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/191ec31c-51a3-4b0b-b22a-ce61a2b9ae99.png)

### 1.5.5 application.cc (修改)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/66637084-c06d-4840-a1c2-320d86a8aec7.png)

### 1.5.6 新增文件

新增文件列表：

../main/boards/common/wifi\_configuration\_smart\_config.h

../main/boards/common/wifi\_configuration\_smart\_config.cc

../main/boards/common/wifi\_configuration\_bluetooth.h

../main/boards/common/wifi\_configuration\_bluetooth.cc

## 1.6 媒体流的Nonce

nonce不需要携带时间戳。

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/5fdc0dc7-60c6-4037-9bad-5c665ded2c25.png)

# 标准规范适配

## 2.1 MCP Server

### 2.1.1 MCP请求中的ID

根据MCP协议（2025-06-18版）的定义，每个MCP请求中必须携带id，如下所示。id可以是数值或字符串

```c

{
  jsonrpc: "2.0";
  id: string | number;
  method: string;
  params?: {
    [key: string]: unknown;
  };
}
```

#### 2.1.1.1 mcp\_server.h (修改)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/44a8fd25-abb6-484e-92a2-8bd0780a6b1a.png)

#### 2.1.1.2 mcp\_server.cc (修改)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/65bc7e53-5f00-4c77-9efa-adaf4e2b8877.png)

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/bfb5eeab-ea7a-433a-a241-0cf3311bb716.png)

### 2.2.2 初始化init

MCP client需要向MCP server发送init来初始化通道。"vision"这个键值不是MCP协议定义的字段。根据MCP协议，将vision改为experimental，如下所示

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/e65e6945-6ca2-4470-af70-6a4a9e6b6580.png)

# 编译参数设置

## 3.1 蓝牙BLE

需要打开BLE组件，通过idy.py menuconfig打开配置，设置路径如下：

Component config > Bluetooth > Bluetooth > Host，设置NimBle-BLE only

![image.png](https://alidocs.oss-cn-zhangjiakou.aliyuncs.com/res/1wvqrebdXMbrpnak/img/6ca772b2-edde-4dbc-af5c-a23c9a059255.png)